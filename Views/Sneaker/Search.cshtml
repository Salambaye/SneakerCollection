@model IEnumerable<Sneaker>
@{
    ViewData["Title"] = "Recherche Avancée";
    var searchTerm = ViewBag.SearchTerm as string;
    var selectedBrand = ViewBag.SelectedBrand as SneakerBrand?;
    var selectedCategory = ViewBag.SelectedCategory as SneakerCategory?;
    var selectedCondition = ViewBag.SelectedCondition as SneakerCondition?;
    var hasFilters = !string.IsNullOrEmpty(searchTerm) || selectedBrand.HasValue || selectedCategory.HasValue || selectedCondition.HasValue;
    var hasResults = Model != null && Model.Any();
}

<div class="container py-4">
    <!-- Header -->
    <div class="text-center mb-5">
        <h1 class="display-6 fw-bold mb-3">
            <i class="bi bi-search text-primary me-3"></i>Recherche Avancée
        </h1>
        <p class="text-muted">Trouvez rapidement la sneaker parfaite dans votre collection</p>
    </div>

    <!-- Formulaire de Recherche Avancée -->
    <div class="card card-custom mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-funnel-fill me-2"></i>Critères de Recherche
            </h5>
        </div>
        <div class="card-body">
            <form method="get" asp-action="Index" class="needs-validation" novalidate>
                <div class="row g-4">
                    <!-- Recherche Textuelle -->
                    <div class="col-12">
                        <label for="searchTerm" class="form-label fw-semibold">
                            <i class="bi bi-type me-1"></i>Recherche Textuelle
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control form-control-lg search-bar" 
                                   id="searchTerm" name="searchTerm" value="@searchTerm" 
                                   placeholder="Recherchez par modèle, marque, colorway ou description...">
                            @if (!string.IsNullOrEmpty(searchTerm))
                            {
                                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            }
                        </div>
                        <div class="form-text">
                            Exemples: "Jordan 1", "Nike", "Chicago", "Basketball"
                        </div>
                    </div>

                    <!-- Filtres par Catégories -->
                    <div class="col-12">
                        <h6 class="border-bottom pb-2">
                            <i class="bi bi-sliders me-2"></i>Filtres Spécifiques
                        </h6>
                    </div>

                    <div class="col-lg-4 col-md-6">
                        <label for="brand" class="form-label fw-semibold">
                            <i class="bi bi-tag-fill me-1"></i>Marque
                        </label>
                        <select class="form-select" id="brand" name="brand">
                            <option value="">Toutes les marques</option>
                            @foreach (SneakerBrand brand in ViewBag.Brands ?? Enum.GetValues<SneakerBrand>())
                            {
                                <option value="@brand" selected="@(selectedBrand == brand)">
                                    @brand.GetDisplayName()
                                </option>
                            }
                        </select>
                    </div>

                    <div class="col-lg-4 col-md-6">
                        <label for="category" class="form-label fw-semibold">
                            <i class="bi bi-grid-fill me-1"></i>Catégorie
                        </label>
                        <select class="form-select" id="category" name="category">
                            <option value="">Toutes les catégories</option>
                            @foreach (SneakerCategory category in ViewBag.Categories ?? Enum.GetValues<SneakerCategory>())
                            {
                                <option value="@category" selected="@(selectedCategory == category)">
                                    @category.GetDisplayName()
                                </option>
                            }
                        </select>
                    </div>

                    <div class="col-lg-4 col-md-6">
                        <label for="condition" class="form-label fw-semibold">
                            <i class="bi bi-award-fill me-1"></i>État
                        </label>
                        <select class="form-select" id="condition" name="condition">
                            <option value="">Tous les états</option>
                            @foreach (SneakerCondition condition in ViewBag.Conditions ?? Enum.GetValues<SneakerCondition>())
                            {
                                <option value="@condition" selected="@(selectedCondition == condition)">
                                    @condition.GetDisplayName()
                                </option>
                            }
                        </select>
                    </div>

                    <!-- Filtres de Prix (ajout bonus) -->
                    <div class="col-lg-6 col-md-6">
                        <label for="minPrice" class="form-label fw-semibold">
                            <i class="bi bi-currency-euro me-1"></i>Prix Minimum
                        </label>
                        <input type="number" class="form-control" id="minPrice" name="minPrice" 
                               min="0" step="10" placeholder="0€">
                    </div>

                    <div class="col-lg-6 col-md-6">
                        <label for="maxPrice" class="form-label fw-semibold">
                            <i class="bi bi-currency-euro me-1"></i>Prix Maximum
                        </label>
                        <input type="number" class="form-control" id="maxPrice" name="maxPrice" 
                               min="0" step="10" placeholder="1000€">
                    </div>

                    <!-- Options Avancées -->
                    <div class="col-12">
                        <h6 class="border-bottom pb-2 mt-3">
                            <i class="bi bi-gear-fill me-2"></i>Options Avancées
                        </h6>
                    </div>

                    <div class="col-12">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="limitedOnly" name="limitedOnly">
                                    <label class="form-check-label fw-semibold" for="limitedOnly">
                                        <i class="bi bi-lightning-fill text-warning me-1"></i>
                                        Éditions limitées uniquement
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="inStock" name="inStock">
                                    <label class="form-check-label fw-semibold" for="inStock">
                                        <i class="bi bi-box-seam text-success me-1"></i>
                                        En stock uniquement
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="sortBy" class="form-label fw-semibold">
                                    <i class="bi bi-sort-down me-1"></i>Trier par
                                </label>
                                <select class="form-select" id="sortBy" name="sortBy">
                                    <option value="recent">Plus récent</option>
                                    <option value="price_asc">Prix croissant</option>
                                    <option value="price_desc">Prix décroissant</option>
                                    <option value="brand">Marque</option>
                                    <option value="model">Modèle</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Boutons d'Action -->
                <div class="row mt-4 pt-3 border-top">
                    <div class="col-12">
                        <div class="d-flex gap-3 justify-content-center">
                            <button type="submit" class="btn btn-primary-custom btn-lg">
                                <i class="bi bi-search me-2"></i>Rechercher
                            </button>
                            
                            @if (hasFilters)
                            {
                                <a href="@Url.Action("Search")" class="btn btn-outline-secondary btn-lg">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Réinitialiser
                                </a>
                            }
                            
                            <a href="@Url.Action("Index")" class="btn btn-outline-custom btn-lg">
                                <i class="bi bi-collection me-2"></i>Voir Toute la Collection
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    @if (hasFilters)
    {
        <!-- Résultats de Recherche -->
        <div class="card card-custom">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        Résultats de Recherche
                        @if (hasResults)
                        {
                            <span class="badge bg-primary ms-2">@Model.Count()</span>
                        }
                    </h5>
                    
                    @if (hasResults)
                    {
                        <small class="text-muted">
                            @Model.Count() sneaker@(Model.Count() > 1 ? "s" : "") trouvée@(Model.Count() > 1 ? "s" : "")
                        </small>
                    }
                </div>
            </div>
            
            <div class="card-body">
                @if (!hasResults)
                {
                    <!-- Aucun Résultat -->
                    <div class="text-center py-5">
                        <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
                        <h4 class="mt-3 text-muted">Aucune sneaker trouvée</h4>
                        <p class="text-muted mb-4">Aucune sneaker ne correspond à vos critères de recherche</p>
                        
                        <div class="d-flex gap-2 justify-content-center flex-wrap">
                            <button class="btn btn-outline-primary" onclick="relaxFilters()">
                                <i class="bi bi-funnel me-2"></i>Élargir la Recherche
                            </button>
                            <a href="@Url.Action("Search")" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise me-2"></i>Nouvelle Recherche
                            </a>
                            <a href="@Url.Action("Create")" class="btn btn-primary-custom">
                                <i class="bi bi-plus-lg me-2"></i>Ajouter une Sneaker
                            </a>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Grille des Résultats -->
                    <div class="row g-4" id="searchResults">
                        @foreach (var sneaker in Model)
                        {
                            <div class="col-lg-4 col-md-6 result-card">
                                <div class="card card-custom h-100">
                                    <div class="position-relative">
                                        <img src="@sneaker.DisplayImageUrl" class="card-img-top sneaker-image" alt="@sneaker.FullName" 
                                             style="height: 200px; object-fit: cover;"
                                             onerror="this.src='https://via.placeholder.com/300x200/f8f9fa/6c757d?text=👟'">
                                        
                                        @if (sneaker.IsLimited)
                                        {
                                            <span class="position-absolute top-0 end-0 m-2">
                                                <span class="badge bg-warning text-dark">
                                                    <i class="bi bi-lightning-fill me-1"></i>Limited
                                                </span>
                                            </span>
                                        }
                                    </div>
                                    
                                    <div class="card-body d-flex flex-column">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <span class="@sneaker.ConditionBadgeClass">@sneaker.Condition.GetDisplayName()</span>
                                            <span class="price-tag">@sneaker.Price.ToString("C")</span>
                                        </div>
                                        
                                        <h6 class="card-title fw-bold mb-2">@sneaker.Model</h6>
                                        <p class="text-muted small mb-2">
                                            @sneaker.Brand.GetDisplayName() - "@sneaker.Colorway"
                                        </p>
                                        
                                        <div class="small text-muted mb-3">
                                            <div class="d-flex justify-content-between">
                                                <span><i class="bi bi-rulers me-1"></i>@sneaker.Size</span>
                                                <span><i class="bi bi-grid-fill me-1"></i>@sneaker.Category.GetDisplayName()</span>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-auto">
                                            <div class="d-flex gap-1">
                                                <a href="@Url.Action("Details", new { id = sneaker.Id })" class="btn btn-primary-custom btn-sm flex-grow-1">
                                                    <i class="bi bi-eye-fill me-1"></i>Voir
                                                </a>
                                                <a href="@Url.Action("Edit", new { id = sneaker.Id })" class="btn btn-outline-secondary btn-sm" title="Modifier">
                                                    <i class="bi bi-pencil-fill"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    
                    <!-- Actions sur les résultats -->
                    <div class="text-center mt-4 pt-3 border-top">
                        <div class="d-flex gap-2 justify-content-center flex-wrap">
                            <a href="@Url.Action("Create")" class="btn btn-primary-custom">
                                <i class="bi bi-plus-lg me-2"></i>Ajouter une Sneaker
                            </a>
                            <button class="btn btn-outline-secondary" onclick="exportResults()">
                                <i class="bi bi-download me-2"></i>Exporter les Résultats
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <!-- Suggestions de Recherche -->
        <div class="row g-4">
            <div class="col-12">
                <h4 class="text-center mb-4">Suggestions de Recherche</h4>
            </div>
            
            <div class="col-md-6">
                <div class="card card-custom">
                    <div class="card-body text-center">
                        <i class="bi bi-lightning-fill text-warning" style="font-size: 3rem;"></i>
                        <h6 class="mt-3 mb-2">Éditions Limitées</h6>
                        <p class="text-muted small mb-3">Trouvez vos sneakers les plus rares</p>
                        <button class="btn btn-outline-custom" onclick="searchLimited()">
                            Rechercher
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card card-custom">
                    <div class="card-body text-center">
                        <i class="bi bi-currency-euro text-success" style="font-size: 3rem;"></i>
                        <h6 class="mt-3 mb-2">Sneakers Premium</h6>
                        <p class="text-muted small mb-3">Prix supérieur à 200€</p>
                        <button class="btn btn-outline-custom" onclick="searchPremium()">
                            Rechercher
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Fonctions utilitaires
        function clearSearch() {
            document.getElementById('searchTerm').value = '';
            document.querySelector('form').submit();
        }

        function searchLimited() {
            document.getElementById('limitedOnly').checked = true;
            document.querySelector('form').submit();
        }

        function searchPremium() {
            document.getElementById('minPrice').value = '200';
            document.querySelector('form').submit();
        }

        function relaxFilters() {
            const selects = document.querySelectorAll('select');
            selects.forEach(select => select.selectedIndex = 0);
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            document.querySelector('form').submit();
        }

        function exportResults() {
            alert('Fonctionnalité d\'export à implémenter');
        }

        // Recherche en temps réel
        let searchTimeout;
        document.getElementById('searchTerm').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length > 2) {
                searchTimeout = setTimeout(() => {
                    // Ici on pourrait implémenter une recherche AJAX
                    console.log('Recherche en temps réel pour :', query);
                    // Exemple de requête AJAX (à adapter selon ton back-end)
                    /*
                    fetch(`@Url.Action("Index")?searchTerm=${encodeURIComponent(query)}`)
                        .then(response => response.text())
                        .then(html => {
                            document.getElementById('searchResults').innerHTML = html;
                        })
                        .catch(error => console.error('Erreur recherche temps réel :', error));
                    */
                }, 500); // délai de 500ms après la frappe pour lancer la recherche
            }
        });
    </script>
}